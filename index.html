<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asta JSON to Markdown</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root {
      --bg: #0f1419;
      --panel: #182028;
      --ink: #e6edf3;
      --muted: #93a4b2;
      --accent: #7ad7ff;
      --border: #26323d;
      --shadow: rgba(0, 0, 0, 0.35);
      --code: #0b0f14;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Source Sans 3", system-ui, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 15% -10%, #1f2b37, transparent 60%),
        radial-gradient(900px 700px at 90% 0%, #162330, transparent 55%),
        var(--bg);
    }

    header {
      padding: 32px 24px 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(1.8rem, 3vw, 2.6rem);
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    p.lede {
      margin: 0;
      color: var(--muted);
      max-width: 700px;
    }

    main {
      max-width: 1100px;
      margin: 0 auto 48px;
      padding: 0 24px 32px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 18px 60px var(--shadow);
    }

    .controls {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
    }

    input[type="file"] {
      width: 100%;
      padding: 12px;
      background: #0c1116;
      color: var(--ink);
      border: 1px dashed var(--border);
      border-radius: 10px;
    }

    button {
      background: var(--accent);
      color: #072331;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      justify-self: start;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(122, 215, 255, 0.25);
    }

    .status {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .preview {
      display: grid;
      gap: 16px;
    }

    .markdown {
      background: #0c1116;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      margin: 0;
    }

    .rendered {
      background: #0d141b;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      line-height: 1.6;
    }

    .rendered h1, .rendered h2, .rendered h3 {
      color: var(--ink);
      margin-top: 1.2em;
    }

    .rendered table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 0.95rem;
    }

    .rendered th, .rendered td {
      border: 1px solid var(--border);
      padding: 8px 10px;
    }

    .rendered th {
      background: #111a22;
    }

    .rendered code {
      background: var(--code);
      padding: 2px 6px;
      border-radius: 6px;
    }

    details {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #0c1116;
      padding: 12px 16px;
    }

    details[open] {
      padding-bottom: 0;
    }

    summary {
      cursor: pointer;
      list-style: none;
      font-weight: 600;
      color: var(--ink);
    }

    summary::-webkit-details-marker {
      display: none;
    }

    summary::after {
      content: "▾";
      float: right;
      color: var(--muted);
    }

    details[open] summary::after {
      content: "▴";
    }

    .download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Asta JSON to Markdown</h1>
    <p class="lede">Drop an <a href="https://asta.allen.ai/" target="_blank">Asta</a> report JSON file, and this page converts it to Markdown entirely in your browser.</p>
  </header>
  <main>
    <section class="panel">
      <div class="controls">
        <input id="fileInput" type="file" accept="application/json" />
        <div>
          <button id="downloadBtn" class="download" type="button" disabled>Download Markdown</button>
          <button id="clearBtn" type="button">Clear</button>
        </div>
        <div class="status" id="status">Waiting for a file.</div>
      </div>
      <div class="preview">
        <details id="markdownDetails">
          <summary>Markdown Source</summary>
          <pre class="markdown" id="markdownOutput">Markdown will appear here.</pre>
        </details>
        <div class="rendered" id="renderedOutput">Rendered Markdown will appear here.</div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const markdownOutput = document.getElementById("markdownOutput");
    const renderedOutput = document.getElementById("renderedOutput");
    const statusEl = document.getElementById("status");
    const clearBtn = document.getElementById("clearBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const markdownDetails = document.getElementById("markdownDetails");

    function formatCitation(cite) {
      const cid = String(cite.id || "").trim() || "(Unknown citation)";
      const paper = cite.paper || {};
      const title = String(paper.title || "").trim();
      const year = paper.year;
      const venue = String(paper.venue || "").trim();

      const parts = [cid];
      if (title) parts.push(`— ${title}`);
      if (venue && year) parts.push(`(${venue}, ${year})`);
      else if (year) parts.push(`(${year})`);
      else if (venue) parts.push(`(${venue})`);

      return parts.join(" ").trim();
    }

    function authorYear(cite) {
      const paper = cite.paper || {};
      const authors = paper.authors || [];
      const year = paper.year;

      let name = "Unknown";
      if (authors.length) {
        const first = String(authors[0].name || "").trim();
        const last = first ? first.split(" ").slice(-1)[0] : "Unknown";
        name = authors.length > 1 ? `${last} et al.` : last;
      }

      return year ? `(${name}, ${year})` : `(${name}, n.d.)`;
    }

    function buildCitationIndex(sections) {
      const index = {};
      sections.forEach((section) => {
        (section.citations || []).forEach((cite) => {
          const paper = cite.paper || {};
          const title = String(paper.title || "").trim().toLowerCase();
          if (title) index[title] = cite;
          const cid = String(cite.id || "").trim();
          if (cid) index[cid.toLowerCase()] = cite;
          const corpusId = String(cite.corpusId || "").trim();
          if (corpusId) index[corpusId] = cite;
        });
      });
      return index;
    }

    function replacePaperTags(text, index) {
      const pattern = /<Paper([^>]*)>([\s\S]*?)<\/Paper>/g;
      return text.replace(pattern, (match, attrs, inner) => {
        const innerText = String(inner || "").trim();
        const titleMatch = /paperTitle\s*=\s*(["'])(.*?)\1/.exec(attrs || "");
        if (titleMatch) return titleMatch[2].trim();

        const key = innerText;
        const cite = index[key.toLowerCase()] || index[key];
        if (cite) return authorYear(cite);

        return innerText || "(Unknown, n.d.)";
      });
    }

    function renderTable(table) {
      const columns = table.columns || [];
      const rows = table.rows || [];
      const cells = table.cells || {};

      const headers = ["Paper", ...columns.map((c) => String(c.name || "").trim())];
      const lines = [`| ${headers.join(" | ")} |`];
      lines.push(`| ${headers.map(() => "---").join(" | ")} |`);

      rows.forEach((row) => {
        const rowId = row.id;
        const rowName = String(row.displayValue || "").trim();
        const values = [rowName];
        columns.forEach((col) => {
          const colId = col.id;
          const cell = cells[`${rowId}_${colId}`] || {};
          values.push(String(cell.displayValue || "").trim());
        });
        lines.push(`| ${values.join(" | ")} |`);
      });

      return lines.join("\n");
    }

    function convertToMarkdown(data) {
      const sections = Array.isArray(data.sections) ? data.sections : [];
      const citationIndex = buildCitationIndex(sections);
      const lines = [];

      sections.forEach((section) => {
        const title = String(section.title || "").trim();
        let text = String(section.text || "").trim();
        if (text) text = replacePaperTags(text, citationIndex);

        if (title) lines.push(`## ${title}`);
        if (text) lines.push(text);

        const table = section.table;
        if (table && table.columns && table.rows) {
          lines.push("");
          lines.push(renderTable(table));
        }
        lines.push("");
      });

      const ordered = new Map();
      sections.forEach((section) => {
        (section.citations || []).forEach((cite) => {
          const cid = String(cite.id || "").trim() || String(cite.corpusId || "").trim();
          if (cid && !ordered.has(cid)) ordered.set(cid, cite);
        });
      });

      if (ordered.size) {
        lines.push("## Citations");
        const citations = Array.from(ordered.values()).sort((a, b) => {
          return formatCitation(a).toLowerCase().localeCompare(formatCitation(b).toLowerCase());
        });
        citations.forEach((cite) => lines.push(`- ${formatCitation(cite)}`));
        lines.push("");
      }

      return lines.join("\n").trim() + "\n";
    }

    function updateOutputs(markdown) {
      markdownOutput.textContent = markdown || "Markdown will appear here.";
      const rawHtml = marked.parse(markdown || "");
      renderedOutput.innerHTML = DOMPurify.sanitize(rawHtml);
      downloadBtn.disabled = !markdown;
    }

    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      statusEl.textContent = `Reading ${file.name}...`;

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        const markdown = convertToMarkdown(data);
        updateOutputs(markdown);
        statusEl.textContent = `Converted ${file.name}.`;
        markdownDetails.open = false;
        downloadBtn.dataset.filename = file.name.replace(/\\.json$/i, "") || "report";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to parse JSON. Make sure this is an Asta report file.";
        updateOutputs("");
      }
    });

    clearBtn.addEventListener("click", () => {
      fileInput.value = "";
      updateOutputs("");
      statusEl.textContent = "Waiting for a file.";
    });

    downloadBtn.addEventListener("click", () => {
      const markdown = markdownOutput.textContent;
      if (!markdown || markdown === "Markdown will appear here.") return;

      const blob = new Blob([markdown], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const base = downloadBtn.dataset.filename || "report";
      link.href = url;
      link.download = `${base}.md`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
